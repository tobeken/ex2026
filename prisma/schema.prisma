generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Participant {
  /// 被験者ID（p001 など）
  id                    String                @id
  group                 LatinGroup
  createdAt             DateTime              @default(now())
  assignments           Assignment[]
  conversationSummaries ConversationSummary[]
  conversationTimings   ConversationTiming[]
  conversationTurns     ConversationTurn[]
  playbackAssets        PlaybackAsset[]
  progressRecords       ParticipantProgress[]
  taskNotes             TaskNote[]
  surveyResponses       SurveyResponse[]
}

model Assignment {
  id            String      @id @default(cuid())
  participantId String
  orderIndex    Int
  taskId        TaskId
  conditionId   ConditionId
  createdAt     DateTime    @default(now())
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, orderIndex])
  @@unique([participantId, taskId])
  @@unique([participantId, conditionId])
  @@index([participantId])
}

model PlaybackAsset {
  id              String      @id @default(cuid())
  participantId   String
  taskId          TaskId
  conditionId     ConditionId
  audioUrl        String
  durationMs      Int?
  sourceSessionId String?
  generatedAt     DateTime    @default(now())
  participant     Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, taskId, conditionId])
  @@index([participantId])
}

model SurveyResponse {
  id            String      @id @default(cuid())
  participantId String
  session       String
  taskId        String?
  stage         String
  condition     String?
  answers       Json
  createdAt     DateTime    @default(now())
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([participantId])
  @@index([session])
  @@index([taskId])
}

model ConversationTurn {
  id            String      @id @default(cuid())
  participantId String
  session       String
  taskId        String
  turnIndex     Int
  role          String
  text          String?
  startedAt     DateTime
  endedAt       DateTime
  durationMs    Int?
  createdAt     DateTime    @default(now())
  audioUrl      String?
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([participantId])
  @@index([session, taskId])
  @@index([participantId, session, taskId, turnIndex])
}

model ConversationTiming {
  id            String      @id @default(cuid())
  participantId String
  session       String
  taskId        String
  event         String
  timestamp     DateTime
  extra         Json?
  createdAt     DateTime    @default(now())
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([participantId])
  @@index([session, taskId])
}

model ConversationSummary {
  id                 String      @id @default(cuid())
  participantId      String
  session            String
  taskId             String
  userUtteranceCount Int         @default(0)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  participant        Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, session, taskId])
  @@index([participantId])
  @@index([session, taskId])
}

model ParticipantProgress {
  id            String   @id @default(cuid())
  participantId String
  session       String
  taskIndex     Int      @default(0)
  stage         String   @default("survey")
  completed     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, session])
  @@index([participantId])
}

model TaskNote {
  id            String      @id @default(cuid())
  participantId String
  taskId        TaskId
  note          String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, taskId])
  @@index([participantId])
}

enum TaskId {
  BIRTHDAY_GIFT
  FAREWELL_PARTY
  WEEKEND_TRIP
}

enum ConditionId {
  NONE
  SUMMARY
  NARRATIVE
}

enum LatinGroup {
  G1
  G2
  G3
  G4
  G5
  G6
  G7
  G8
  G9
}
